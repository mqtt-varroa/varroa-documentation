\chapter{Architecture}
Varroas architecture is organised as a distributed system, whereas there are two main roles in the system: the Agents and the Commander.
The Commander is the central unit that passes work packages of the Scenario to the Agents.
In contrast the Agents process the passed packages and create MQTT clients to execute the testing process.
%The Commander parses the Scenario, splits it into chunks and then distributes it among the agents.

\section{Varroa Distributed System Architecture}
\begin{figure}[h]
	\begin{center}
	\includegraphics[scale=0.65]{Resources/PDF/Architecture}
	\caption{Varroa Distributed System Architecture}
	\label{pic:Architecture}
	\end{center}
\end{figure}
A Varroa Distributed System is composed of a Commander and multiple Agents.
The Commander and all Agents are executed in separate Varroa Instances.
Every Agent holds a number of MQTT Agents and each MQTT Agent manages one MQTT Client.
\newpage

\section{Commander}
\begin{figure}[h]
	\begin{center}
	\includegraphics[scale=1]{Resources/PDF/CommanderStates}
	\caption{Commander States}
	\label{pic:CommanderStates}
	\end{center}
\end{figure}

\section{Chunk Concept}
\subsection{Definition}
A chunk is a work package of the scenario execution designed to be distributed from the Commander to its Agents.
It is then handled by the Agent it is distributed to.
The Agent now creates or uses existing MQTT Agents to execute the Chunk.
It contains:
\begin{itemize}
	\item \textbf{clientCountInChunk}: the maximum amount of clients a chunk can represent.
	\item \textbf{clientOffset}: starting index of the clients contained in the chunk.
	\item \textbf{clientGroupId}: 
	\item \textbf{clientGroupInformation}: contains information concerning the Client Group and MQTT-specific properties.
	\item \textbf{stageDuration}: the duration of the stage this chunk belongs to.
	\item \textbf{lifecycleRate}: the rate at which the contained commands are executed.
	\item \textbf{commands}: a list of commands that are executed by the clients in the chunk.
\end{itemize}
%Due to the distributed nature of Varroa it was necessary to be able to spread the information contained in the scenario.
%To secure a deterministic distribution of a scenario's data the chunks had to be evenly spread across the initialized Agents.

\section{Chunk Distribution}
To secure a deterministic execution of a scenario the every chunk needs to be distributed to the same Agent in every execution of the scenario.
To ensure this determinism a mechanism was introduced combining a round-robin selection of chunks with a handshake mechanism of the agents.
\begin{figure}[h]
	\begin{center}
	\includegraphics[scale=1]{Resources/PDF/ChunkDistribution}
	\caption{Distribution of a Chunk}
	\label{pic:ChunkDistribution}
	\end{center}
\end{figure}

\section{Chunk Handshake}
\begin{figure}[h]
	\begin{center}
	\includegraphics[scale=1]{Resources/PDF/ChunkAcceptedHandshake}
	\caption{Chunk Handshake with Accept}
	\label{pic:ChunkAcceptedHandshake}
	\end{center}
\end{figure}

\begin{figure}[h]
	\begin{center}
	\includegraphics[scale=1]{Resources/PDF/ChunkRejectHandshake}
	\caption{Chunk Handshake with Reject}
	\label{pic:ChunkRejectHandshake}
	\end{center}
\end{figure}